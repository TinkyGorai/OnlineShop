{% extends 'base/base.html' %}
{% block content %}
<section class="cart-section">
 <div class="container">
  {% if cartitems.count == 0 %}
  <div class="empty-cart">
    <h5>Your cart is empty!</h5>
    <p>Explore our products and find something you like</p>
  </div>

  {% else %}
  <div class="row">
    
    <main class="cart-items col-md-9">
      <div class="cart-box">
    
          <table class="cart-table">
            <thead>
              <tr>
                <th>Product</th>
                <th width="120">Quantity</th>
                <th width="120">Price</th>
                <th width="200" class="text-right"></th>
              </tr>
            </thead>
            <tbody>
                {% for item in cartitems %}
             <tr>
              <td>
                <figure class="cart-item">
                  <div class="cart-img">
                    <a href="{% url 'product_detail' item.products.slug %}">
                      <img src="{{ item.products.product_colors.first.image.url }}" class="img-sm">
                    </a>
                  </div>
                  <figcaption>
                    <a href="#" class="cart-title">{{ item.products.product_name }}</a>
                    <p class="cart-details">{%if item.size_variant.size %}Size: {{ item.size_variant.size }}{%endif%}{%if item.color_variant.color %}, Color: {{ item.color_variant.color }}{%endif%}{%if item.brand %},Brand: {{ item.brand }}{%endif%}</p>
                  </figcaption>
                </figure>
              </td>
              <td>
                <div class="quantity-box">
                  
                  
                  
                  <button class="btn minus-btn" data-uid="{{ item.uid }}" data-action="decrease"><a style="text-decoration: none;" href="{% url 'modified_cart' item.uid 'decrease' %}">➖</a></button>
                  <input type="text" class="quantity-input" id="quantity-{{ item.uid }}" value="{{ item.quantity }}" data-price="{{ item.get_product_price|default:0 }}" readonly>
                  <button class="btn plus-btn" data-uid="{{ item.uid }}" data-action="increase"><a style="text-decoration: none;" href="{% url 'modified_cart' item.uid 'increase' %}">➕</a></button>
              </div>
              </td>
              <td>
                  <div class="price-box"> 
                      <span id="price-{{ item.uid }}" class="price">RS {{ item.get_product_price }}.00/-</span> 
                  </div>
              </td>
              <td class="text-right">
               <!-- <a href="#" class="wishlist-btn"> <i class="fa fa-heart"></i></a>  -->
               <a href="{% url 'remove_from_cart' item.uid %}" class="remove-btn"> Remove</a>
              </td>
             </tr>
             {% endfor %}
            </tbody>
          </table>
    
       
      </div> 

      <div class="delivery-info">
        <p><i class="icon fa fa-truck"></i> Free Delivery within 1-2 weeks</p>
      </div>
    
    </main>

    <aside class="cart-summary col-md-3">
        <div class="total-box">
            <div class="total-row">
              <span>Total:</span>
              <strong id="cartTotal">Rs {{ cart.get_cart_total }}/-</strong>
            </div>
            <hr>
            <p class="payment-options">
                <img src="images/misc/payments.png" height="26">
            </p>
        </div>
    </aside>
    <div class="cart-footer">
      <button id="place-order-btn" class="btn checkout-btn"> Place Order </button>
      <a href="#" class="btn continue-btn"> <i class="fa fa-chevron-left"></i> Continue Shopping </a>
    </div>	
  </div>


<!-- Update the order form -->
<div id="order-form" class="order-form" style="display: none;">
    <h4>Deliver to this address</h4>
    <form method="POST" action="{% url 'order' %}">
        {% csrf_token %}
        <input type="email" name="email" placeholder="Email Address" value="{{ last_order.email }}" required>
        <input type="text" name="phone" placeholder="Phone Number" value="{{ last_order.mobile|default:'' }}" required>
        <textarea name="address" placeholder="Shipping Address" required>{{ last_order.shipping_address|default:'' }}</textarea>

        <!-- Include hidden inputs for cart details -->
        {% for item in cartitems %}
        <input type="hidden" name="cart_items" value="{{ item.products.product_name }} (Size: {{ item.size_variant }}, Color: {{ item.color_variant }}, Price: Rs {{ item.get_product_price }})">
        {% endfor %}
        <input type="hidden" name="total_amount" id="totalAmountInput" value="{{ cart.get_cart_total }}">

        <button type="submit" name="payment_method" value="COD" class="btn cod-btn">Cash on Delivery</button>
        <button type="submit" name="payment_method" value="Online" id="rzp-button1" class="btn online-btn">Pay Now</button>
    </form>
</div>

  {% endif %}
 </div>
</section>





<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
  document.getElementById("place-order-btn").addEventListener("click", function() {
      document.getElementById("order-form").style.display = "block";
  });

  var options = {
      "key": "rzp_test_jkmzOPacv3Y99Y",
      "amount": "{{payment.amount}}",
      "currency": "INR",
      "name": "Ecomm",
      "description": "Purchase",
      "image": "https://example.com/your_logo",
      "order_id": "{{payment.id}}",
      "handler": function (response){
          window.location.href=`http://127.0.0.1:8000/accounts/success/?razorpay_payment_id=${response.razorpay_payment_id}&razorpay_order_id=${response.razorpay_order_id}&razorpay_signature=${response.razorpay_signature}`;
      },
      "theme": { "color": "#3399cc" }
  };

  var rzp1 = new Razorpay(options);
  document.getElementById('rzp-button1').onclick = function(e){
      rzp1.open();
      e.preventDefault();
  };
</script>

{% endblock %}
